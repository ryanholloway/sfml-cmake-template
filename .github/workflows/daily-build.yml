name: CI - Daily Build

on:
  schedule:
    - cron: "0 0 * * *" # daily at 00:00 UTC
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    name: Build on Windows
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure (Windows)
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
        shell: pwsh

      - name: Build (Windows)
        run: |
          # Ensure build directory exists
          if (-not (Test-Path -Path build)) { New-Item -ItemType Directory -Path build | Out-Null }

          # Run build with detailed verbosity and stream output to console and file
          # Use Tee-Object so the log is written while output still appears in Actions console
          cmake --build build --config Release -- /verbosity:detailed 2>&1 | Tee-Object -FilePath build\build.log

          # Preserve and propagate exit code from the build tool
          if ($LASTEXITCODE -ne 0) {
            Write-Output "Build failed. See build\build.log"
            exit $LASTEXITCODE
          }
        shell: pwsh

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cmake-build-windows
          path: |
            build\build.log
            build
